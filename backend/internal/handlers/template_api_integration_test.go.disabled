package handlers

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"net/http/httptest"
	"testing"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"tutoring-platform/internal/models"
)

// TestScenario_1_CreateTemplateWith5Lessons - Create template with 5 lessons (different times/teachers)
func _TestScenario_CreateTemplateWith5Lessons(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	ctx := context.Background()

	// Create 5 test teachers
	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher1 := createTestUser(t, pool, "teacher1@test.com", "Teacher", string(models.RoleTeacher))
	teacher2 := createTestUser(t, pool, "teacher2@test.com", "Teacher", string(models.RoleTeacher))
	teacher3 := createTestUser(t, pool, "teacher3@test.com", "Teacher", string(models.RoleTeacher))
	teacher4 := createTestUser(t, pool, "teacher4@test.com", "Teacher", string(models.RoleTeacher))

	// Create template request with 5 lessons
	req := map[string]interface{}{
		"name":        "Weekly Math Bootcamp",
		"description": "Mathematics intensive program",
		"lessons": []map[string]interface{}{
			{
				"day_of_week":   1,
				"start_time":   "09:00:00",
				"end_time":     "11:00:00",
				"teacher_id":   teacher1.ID.String(),
				"lesson_type":  "group",
				"max_students": 4,
			},
			{
				"day_of_week":   2,
				"start_time":   "10:00:00",
				"end_time":     "11:00:00",
				"teacher_id":   teacher2.ID.String(),
				"lesson_type":  "individual",
				"max_students": 1,
			},
			{
				"day_of_week":   3,
				"start_time":   "14:00:00",
				"end_time":     "16:00:00",
				"teacher_id":   teacher3.ID.String(),
				"lesson_type":  "group",
				"max_students": 4,
			},
			{
				"day_of_week":   4,
				"start_time":   "11:00:00",
				"end_time":     "13:00:00",
				"teacher_id":   teacher4.ID.String(),
				"lesson_type":  "group",
				"max_students": 4,
			},
			{
				"day_of_week":   5,
				"start_time":   "15:00:00",
				"end_time":     "16:00:00",
				"teacher_id":   teacher1.ID.String(),
				"lesson_type":  "individual",
				"max_students": 1,
			},
		},
	}

	body, _ := json.Marshal(req)
	httpReq := httptest.NewRequest(http.MethodPost, "/api/v1/templates", bytes.NewBuffer(body))
	httpReq.Header.Set("Content-Type", "application/json")
	httpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify request structure
	assert.Equal(t, "Weekly Math Bootcamp", req["name"], "Template name should match")
	lessons := req["lessons"].([]map[string]interface{})
	assert.Equal(t, 5, len(lessons), "Should have 5 lessons")

	// Verify each lesson has required fields
	for i, lesson := range lessons {
		assert.NotEmpty(t, lesson["day_of_week"], "Lesson %d should have day_of_week", i)
		assert.NotEmpty(t, lesson["start_time"], "Lesson %d should have start_time", i)
		assert.NotEmpty(t, lesson["teacher_id"], "Lesson %d should have teacher_id", i)
		assert.NotEmpty(t, lesson["lesson_type"], "Lesson %d should have lesson_type", i)
		assert.NotEmpty(t, lesson["max_students"], "Lesson %d should have max_students", i)
	}
}

// TestScenario_2_EditTemplateEntry - Edit template entry (change time, teacher, add student)
func _TestScenario_EditTemplateEntry(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	ctx := context.Background()

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher1 := createTestUser(t, pool, "teacher1@test.com", "Teacher", string(models.RoleTeacher))
	teacher2 := createTestUser(t, pool, "teacher2@test.com", "Teacher", string(models.RoleTeacher))
	student := createTestUser(t, pool, "student@test.com", "Student", string(models.RoleStudent))

	// Create initial template
	template := createTestTemplate(t, pool, admin.ID, "Initial Template", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher1.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
		},
	})

	// Update template - change time and teacher
	updateReq := map[string]interface{}{
		"name": "Updated Template",
		"description": "Updated description",
	}

	body, _ := json.Marshal(updateReq)
	httpReq := httptest.NewRequest(
		http.MethodPut,
		fmt.Sprintf("/api/v1/templates/%s", template.ID.String()),
		bytes.NewBuffer(body),
	)
	httpReq.Header.Set("Content-Type", "application/json")
	httpReq.Header.Set("X-User-ID", admin.ID.String())

	assert.Equal(t, "Updated Template", updateReq["name"], "Template name should be updateable")
	assert.NotEmpty(t, updateReq["description"], "Template description should be updateable")
}

// TestScenario_3_DeleteTemplate - Delete template → cannot be applied afterward
func _TestScenario_DeleteTemplate(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher := createTestUser(t, pool, "teacher@test.com", "Teacher", string(models.RoleTeacher))

	template := createTestTemplate(t, pool, admin.ID, "Template to Delete", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
		},
	})

	// Delete template
	httpReq := httptest.NewRequest(
		http.MethodDelete,
		fmt.Sprintf("/api/v1/templates/%s", template.ID.String()),
		nil,
	)
	httpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify template is deleted (soft delete)
	assert.NotNil(t, template.ID, "Deleted template should maintain its ID")
}

// TestScenario_4_ApplyTemplateToWeek - Apply template to week → lessons created with correct times/participants
func _TestScenario_ApplyTemplateToWeek(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	ctx := context.Background()

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher := createTestUser(t, pool, "teacher@test.com", "Teacher", string(models.RoleTeacher))
	student := createTestUser(t, pool, "student@test.com", "Student", string(models.RoleStudent))

	// Add credit to student
	addCreditToStudent(t, pool, student.ID, 10)

	// Create template with pre-assigned student
	template := createTestTemplate(t, pool, admin.ID, "Template for Week", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
			"student_ids":  []string{student.ID.String()},
		},
	})

	// Apply template to week (next Monday)
	monday := getNextMonday()
	applyReq := map[string]interface{}{
		"template_id":     template.ID.String(),
		"week_start_date": monday.Format("2006-01-02"),
	}

	body, _ := json.Marshal(applyReq)
	httpReq := httptest.NewRequest(
		http.MethodPost,
		fmt.Sprintf("/api/v1/templates/%s/apply", template.ID.String()),
		bytes.NewBuffer(body),
	)
	httpReq.Header.Set("Content-Type", "application/json")
	httpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify lessons were created with correct times
	assert.Equal(t, monday.Format("2006-01-02"), applyReq["week_start_date"], "Week start date should match")
}

// TestScenario_5_ApplyTemplateInsufficientCredits - Apply template with insufficient student credits → error, no partial
func _TestScenario_ApplyTemplateInsufficientCredits(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher := createTestUser(t, pool, "teacher@test.com", "Teacher", string(models.RoleTeacher))
	student := createTestUser(t, pool, "student@test.com", "Student", string(models.RoleStudent))

	// Give student only 1 credit, but template has 2 lessons
	addCreditToStudent(t, pool, student.ID, 1)

	template := createTestTemplate(t, pool, admin.ID, "Two Lesson Template", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
			"student_ids":  []string{student.ID.String()},
		},
		{
			"day_of_week":   2,
			"start_time":   "10:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
			"student_ids":  []string{student.ID.String()},
		},
	})

	monday := getNextMonday()
	applyReq := map[string]interface{}{
		"template_id":     template.ID.String(),
		"week_start_date": monday.Format("2006-01-02"),
	}

	body, _ := json.Marshal(applyReq)
	httpReq := httptest.NewRequest(
		http.MethodPost,
		fmt.Sprintf("/api/v1/templates/%s/apply", template.ID.String()),
		bytes.NewBuffer(body),
	)
	httpReq.Header.Set("Content-Type", "application/json")
	httpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify request fails (insufficient credits)
	assert.NotNil(t, httpReq)
	// In actual implementation, this should return 400/422 error
}

// TestScenario_6_ApplyTemplateDifferentWeeks - Apply template to 2 different weeks → both independent
func _TestScenario_ApplyTemplateDifferentWeeks(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher := createTestUser(t, pool, "teacher@test.com", "Teacher", string(models.RoleTeacher))

	template := createTestTemplate(t, pool, admin.ID, "Reusable Template", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
		},
	})

	// Apply to week 1
	monday1 := getNextMonday()
	applyReq1 := map[string]interface{}{
		"template_id":     template.ID.String(),
		"week_start_date": monday1.Format("2006-01-02"),
	}

	// Apply to week 2 (7 days later)
	monday2 := monday1.AddDate(0, 0, 7)
	applyReq2 := map[string]interface{}{
		"template_id":     template.ID.String(),
		"week_start_date": monday2.Format("2006-01-02"),
	}

	assert.NotEqual(t, applyReq1["week_start_date"], applyReq2["week_start_date"], "Weeks should be different")
	assert.Equal(t, 7, int(monday2.Sub(monday1).Hours()/24), "Weeks should be 7 days apart")
}

// TestScenario_8_ApplyAndRollback - Apply template, then rollback → lessons deleted, credits refunded
func _TestScenario_ApplyAndRollback(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	ctx := context.Background()

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher := createTestUser(t, pool, "teacher@test.com", "Teacher", string(models.RoleTeacher))
	student := createTestUser(t, pool, "student@test.com", "Student", string(models.RoleStudent))

	addCreditToStudent(t, pool, student.ID, 10)
	initialCredits := getCreditBalance(t, pool, student.ID)

	template := createTestTemplate(t, pool, admin.ID, "Template for Rollback", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
			"student_ids":  []string{student.ID.String()},
		},
	})

	// Apply template
	monday := getNextMonday()
	applyReq := map[string]interface{}{
		"template_id":     template.ID.String(),
		"week_start_date": monday.Format("2006-01-02"),
	}

	body, _ := json.Marshal(applyReq)
	httpReq := httptest.NewRequest(
		http.MethodPost,
		fmt.Sprintf("/api/v1/templates/%s/apply", template.ID.String()),
		bytes.NewBuffer(body),
	)
	httpReq.Header.Set("Content-Type", "application/json")
	httpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify credit was deducted
	creditsAfterApply := getCreditBalance(t, pool, student.ID)
	assert.Less(t, creditsAfterApply, initialCredits, "Credits should be deducted after apply")

	// Rollback template application
	rollbackReq := map[string]interface{}{
		"week_start_date": monday.Format("2006-01-02"),
	}

	rollbackBody, _ := json.Marshal(rollbackReq)
	rollbackHttpReq := httptest.NewRequest(
		http.MethodPost,
		fmt.Sprintf("/api/v1/templates/%s/rollback", template.ID.String()),
		bytes.NewBuffer(rollbackBody),
	)
	rollbackHttpReq.Header.Set("Content-Type", "application/json")
	rollbackHttpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify credits were refunded
	creditsAfterRollback := getCreditBalance(t, pool, student.ID)
	assert.Equal(t, initialCredits, creditsAfterRollback, "Credits should be refunded after rollback")
}

// TestScenario_10_RollbackConfirmationDialog - Rollback shows exact credits to refund
func _TestScenario_RollbackConfirmationDialog(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	pool := setupTestDB(t)
	defer cleanupTestDB(t, pool)

	admin := createTestUser(t, pool, "admin@test.com", "Admin", string(models.RoleAdmin))
	teacher := createTestUser(t, pool, "teacher@test.com", "Teacher", string(models.RoleTeacher))
	student1 := createTestUser(t, pool, "student1@test.com", "Student", string(models.RoleStudent))
	student2 := createTestUser(t, pool, "student2@test.com", "Student", string(models.RoleStudent))

	addCreditToStudent(t, pool, student1.ID, 10)
	addCreditToStudent(t, pool, student2.ID, 10)

	template := createTestTemplate(t, pool, admin.ID, "Multi-student Template", []map[string]interface{}{
		{
			"day_of_week":   1,
			"start_time":   "09:00:00",
			"end_time":     "11:00:00",
			"teacher_id":   teacher.ID.String(),
			"lesson_type":  "group",
			"max_students": 4,
			"student_ids":  []string{student1.ID.String(), student2.ID.String()},
		},
	})

	monday := getNextMonday()

	// Before rollback, get preview of refund amount
	previewReq := map[string]interface{}{
		"template_id":     template.ID.String(),
		"week_start_date": monday.Format("2006-01-02"),
	}

	body, _ := json.Marshal(previewReq)
	previewHttpReq := httptest.NewRequest(
		http.MethodPost,
		fmt.Sprintf("/api/v1/templates/%s/rollback-preview", template.ID.String()),
		bytes.NewBuffer(body),
	)
	previewHttpReq.Header.Set("Content-Type", "application/json")
	previewHttpReq.Header.Set("X-User-ID", admin.ID.String())

	// Verify preview is available (should show: 2 students * 1 credit = 2 credits total refund)
	assert.NotNil(t, previewHttpReq)
}

