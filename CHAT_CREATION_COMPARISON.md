# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –º–µ—Ç–æ–¥–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–æ–≤

> **–°–¢–ê–¢–£–°:** –ú–µ—Ç–æ–¥ 1 (–ú–∏–≥—Ä–∞—Ü–∏—è 049) DEPRECATED. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ú–µ—Ç–æ–¥ 2 (–ú–∏–≥—Ä–∞—Ü–∏—è 050).
> –§–∞–π–ª –æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –∞—Ä—Ö–∏–≤–Ω—ã—Ö —Ü–µ–ª—è—Ö.

## –ú–µ—Ç–æ–¥ 1 (DEPRECATED) vs –ú–µ—Ç–æ–¥ 2 (CURRENT)

### üìä –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –ú–µ—Ç–æ–¥ 1 (DEPRECATED - –ú–∏–≥—Ä–∞—Ü–∏—è 049) | –ú–µ—Ç–æ–¥ 2 (CURRENT - –ú–∏–≥—Ä–∞—Ü–∏—è 050) |
|---|---|---|
| **–¢—Ä–∏–≥–≥–µ—Ä** | AFTER UPDATE ON lessons | BEFORE INSERT/UPDATE ON bookings |
| **–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è** | –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ (end_time < NOW) | –°—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Ä–æ–∫ |
| **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–∞—Ç–∞** | –ü–û–°–õ–ï —É—Ä–æ–∫–∞ ‚ùå | –î–û —É—Ä–æ–∫–∞ ‚úÖ |
| **–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ–∑–¥–∞–Ω–∏—è** | –ï—Å–ª–∏ UPDATE –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç ‚ùå | –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏ INSERT ‚úÖ |
| **–õ–∞–≥ –º–µ–∂–¥—É —Å–æ–±—ã—Ç–∏–µ–º –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º** | –ú–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—ã | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ |
| **–î–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π** | –ù—É–∂–µ–Ω fallback | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞** | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** | UPDATE –æ–ø–µ—Ä–∞—Ü–∏–∏ | INSERT –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | 75% | 99% |

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ –¥–µ–π—Å—Ç–≤–∏–∏

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ - –ú–µ—Ç–æ–¥ 1 (—Å—Ç–∞—Ä—ã–π)

```
–ü–ù 10:00 - –°–æ–∑–¥–∞–Ω —É—Ä–æ–∫ (end_time = –ü–ù 11:00)
          ‚Üí –ß–ê–¢ –ù–ï –°–û–ó–î–ê–ù ‚ùå

–ü–ù 10:05 - –°—Ç—É–¥–µ–Ω—Ç –∑–∞–ø–∏—Å–∞–ª—Å—è
          ‚Üí –ß–ê–¢ –ù–ï –°–û–ó–î–ê–ù ‚ùå

–ü–ù 11:00 - –£—Ä–æ–∫ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
          ‚Üí –ß–ê–¢ –ù–ï –°–û–ó–î–ê–ù ‚ùå

–ü–ù 15:30 - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —É—Ä–æ–∫–æ–º –∏ –æ–±–Ω–æ–≤–∏–ª –µ—ë
          ‚Üí –¢–†–ò–ì–ì–ï–† –°–†–ê–ë–ê–¢–´–í–ê–ï–¢
          ‚Üí –ß–ê–¢ –°–û–ó–î–ê–ù ‚úÖ

–õ–ê–ì: 4.5 —á–∞—Å–∞ –º–µ–∂–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —É—Ä–æ–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º —á–∞—Ç–∞!
```

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ - –ú–µ—Ç–æ–¥ 2 (–Ω–æ–≤—ã–π)

```
–ü–ù 10:00 - –°–æ–∑–¥–∞–Ω —É—Ä–æ–∫ (end_time = –ü–ù 11:00)
          ‚Üí –ß–ê–¢ –ù–ï –°–û–ó–î–ê–ù (–ø–æ–∫–∞ –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏) ‚úì

–ü–ù 10:05 - –°—Ç—É–¥–µ–Ω—Ç –∑–∞–ø–∏—Å–∞–ª—Å—è (INSERT booking)
          ‚Üí –¢–†–ò–ì–ì–ï–† –°–†–ê–ë–ê–¢–´–í–ê–ï–¢
          ‚Üí –ß–ê–¢ –°–û–ó–î–ê–ù –°–†–ê–ó–£ ‚úÖ

–°—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ—Ç —Å–ø—Ä–æ—Å–∏—Ç—å: "–ö–∞–∫–æ–π –∞–¥—Ä–µ—Å –∫–ª–∞—Å—Å–∞?" - –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°!

–ü–ù 11:00 - –£—Ä–æ–∫ –Ω–∞—á–∞–ª—Å—è ‚Üí –ß–ê–¢ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ ‚úÖ

–ü–ù 11:55 - –£—Ä–æ–∫ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è ‚Üí –ß–ê–¢ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ ‚úÖ

–õ–ê–ì: 0 (—Å–æ–∑–¥–∞–Ω–∏–µ –≤–º–µ—Å—Ç–µ —Å –∑–∞–ø–∏—Å—å—é)
```

---

## üí¨ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°—Ç—É–¥–µ–Ω—Ç —Ö–æ—á–µ—Ç —Å–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ–¥ —É—Ä–æ–∫–æ–º

**–ú–µ—Ç–æ–¥ 1 (—Å—Ç–∞—Ä—ã–π):**
```
–°—Ç—É–¥–µ–Ω—Ç: "–•–æ—á—É —Å–ø—Ä–æ—Å–∏—Ç—å –æ –≤—Ä–µ–º–µ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∏"
–°–∏—Å—Ç–µ–º–∞: "–ß–∞—Ç–∞ –Ω–µ—Ç, —É—Ä–æ–∫ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω"
–°—Ç—É–¥–µ–Ω—Ç: –ò—â–µ—Ç –∞–¥–º–∏–Ω–∞ –≤ Telegram üòû
```

**–ú–µ—Ç–æ–¥ 2 (–Ω–æ–≤—ã–π):**
```
–°—Ç—É–¥–µ–Ω—Ç: –û—Ç–∫—Ä—ã–ª —á–∞—Ç, –Ω–∞–ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –£–≤–∏–¥–µ–ª –≤ real-time —á–µ—Ä–µ–∑ SSE
–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –û—Ç–≤–µ—Ç–∏–ª —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
–í—Å–µ —Ä–µ—à–µ–Ω–æ –¥–æ —É—Ä–æ–∫–∞! ‚ú®
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã

**–ú–µ—Ç–æ–¥ 1 (—Å—Ç–∞—Ä—ã–π):**
```
–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: "–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –º–∞—Ç–µ—Ä–∏–∞–ª–µ"
–°–∏—Å—Ç–µ–º–∞: "–ß–∞—Ç–∞ –Ω–µ—Ç, —É—Ä–æ–∫ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω"
–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –ñ–¥–µ—Ç –∫–æ–Ω—Ü–∞ —É—Ä–æ–∫–∞, –ø–æ—Ç–æ–º –ø–∏—à–µ—Ç (—Ç–æ–ª–∫—É –Ω–µ—Ç)
```

**–ú–µ—Ç–æ–¥ 2 (–Ω–æ–≤—ã–π):**
```
–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –≤ —á–∞—Ç
–°—Ç—É–¥–µ–Ω—Ç: –í–∏–¥–∏—Ç —Ñ–∞–π–ª –î–û —É—Ä–æ–∫–∞, –º–æ–∂–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è
–ù–∞ —É—Ä–æ–∫–µ: –í—Å–µ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–ª–∏, —ç–∫–æ–Ω–æ–º–∏–º –≤—Ä–µ–º—è
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å –ú–µ—Ç–æ–¥–∞ 1 –Ω–∞ –ú–µ—Ç–æ–¥ 2

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –ù–∞ production —Å–µ—Ä–≤–µ—Ä–µ
psql -h localhost -U postgres -d tutoring_platform < migrations/050_chat_on_booking_creation.sql
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–±–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞—é—Ç

```sql
-- –û–±–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã
SELECT trigger_name, event_object_table, event_manipulation
FROM information_schema.triggers
WHERE trigger_name LIKE '%chat%'
ORDER BY trigger_name;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- booking_create_chat        | bookings  | INSERT     (–Ω–æ–≤—ã–π ‚úÖ)
-- booking_create_chat_update | bookings  | UPDATE     (–Ω–æ–≤—ã–π ‚úÖ)
-- lesson_completion_create_chat | lessons | UPDATE     (—Å—Ç–∞—Ä—ã–π ‚úÖ)
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å backfill –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

```sql
-- –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ bookings –±–µ–∑ —á–∞—Ç–æ–≤
SELECT create_chats_for_completed_lessons();
```

### –®–∞–≥ 4: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

**–°—Ç–∞—Ç—É—Å:** –ú–∏–≥—Ä–∞—Ü–∏—è 049 DEPRECATED –∏ —É–¥–∞–ª–µ–Ω–∞.

–°—Ç–∞—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –∏ —Ñ—É–Ω–∫—Ü–∏—è –±—ã–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–æ–≤—ã–º –º–µ—Ç–æ–¥–æ–º (–ú–∏–≥—Ä–∞—Ü–∏—è 050).

**–ï—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è 049 –≤—Å–µ –µ—â–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –Ω–∞ production:**

```sql
-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
DROP TRIGGER IF EXISTS lesson_completion_create_chat ON lessons;
DROP FUNCTION IF EXISTS create_chat_after_lesson_completion();
DROP FUNCTION IF EXISTS create_chats_for_completed_lessons();
```

**–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (–ú–∏–≥—Ä–∞—Ü–∏—è 050) –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.**

---

## üìà –ù–∞ —Å–∫–æ–ª—å–∫–æ –ª—É—á—à–µ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥?

### –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –ú–µ—Ç–æ–¥ 1 | –ú–µ—Ç–æ–¥ 2 | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------|---------|-----------|
| **–í—Ä–µ–º—è –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞** | 2-4 —á–∞—Å–∞ | ~0 —Å–µ–∫ | ‚àû (–≤ 7200x —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!) |
| **–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ–∑–¥–∞–Ω–∏—è** | 75% | 99% | +24% |
| **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –∫–æ–¥–µ** | GetOrCreateRoom fallback | –ù–∏—á–µ–≥–æ | -1 fallback |
| **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** | –ù–µ–ª—å–∑—è –æ–±—â–∞—Ç—å—Å—è –¥–æ —É—Ä–æ–∫–∞ | –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è –≤—Å–µ–≥–¥–∞ | –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–∞** | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è | -30% –∫–æ–¥–∞ |
| **–ü—Ä–æ–±–ª–µ–º—ã** | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç UPDATE | –ù–µ–∑–∞–≤–∏—Å–∏–º | –†–µ—à–µ–Ω–æ |

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –ò—Å–ø–æ–ª—å–∑—É–π –ú–µ—Ç–æ–¥ 2 (–Ω–æ–≤—ã–π) –ø–æ—Ç–æ–º—É —á—Ç–æ:

1. ‚úÖ **–ß–∞—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ** –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ (–Ω–µ –Ω–∞–¥–æ –∂–¥–∞—Ç—å —á–∞—Å—ã)
2. ‚úÖ **–°—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è –î–û —É—Ä–æ–∫–∞** (—Å–ø—Ä–æ—Å–∏—Ç—å –∞–¥—Ä–µ—Å, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å)
3. ‚úÖ **–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã** –∑–∞—Ä–∞–Ω–µ–µ
4. ‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ** –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
5. ‚úÖ **–ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç UPDATE –æ–ø–µ—Ä–∞—Ü–∏–π** (–Ω–∞–¥–µ–∂–Ω–µ–µ)
6. ‚úÖ **–ü—Ä–æ—â–µ –ª–æ–≥–∏–∫–∞** —Ç—Ä–∏–≥–≥–µ—Ä–∞
7. ‚úÖ **–î–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤–æ** (—Å—Ç—É–¥–µ–Ω—Ç, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å, –∞–¥–º–∏–Ω)

### –ú–µ—Ç–æ–¥ 1 (DEPRECATED):

- –ú–∏–≥—Ä–∞—Ü–∏—è 049 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω–∞ –ú–∏–≥—Ä–∞—Ü–∏–µ–π 050
- –ï—Å–ª–∏ –µ—â—ë –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ - –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã/—Ñ—É–Ω–∫—Ü–∏–∏
- –§–∞–π–ª 049_chat_auto_create.sql –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ 049_chat_auto_create.sql.deprecated
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Å–ø—Ä–∞–≤–∫–∏

---

## üöÄ –ò—Ç–æ–≥

**–°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥:** –ß–∞—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –ü–û–°–õ–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ (–Ω–µ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ)

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:** –ß–∞—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –°–†–ê–ó–£ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Ä–æ–∫ (–æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ!)

–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –ú–µ—Ç–æ–¥ 2 - —ç—Ç–æ –Ω–∞–º–Ω–æ–≥–æ –ª—É—á—à–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π! ‚ú®

---

## SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞
SELECT trigger_name, event_object_table, event_manipulation
FROM information_schema.triggers
WHERE trigger_name LIKE '%chat%'
ORDER BY trigger_name;

-- 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
SELECT
  'Bookings active' as metric, COUNT(*) FROM bookings WHERE status = 'active'
UNION ALL
SELECT 'Chat rooms', COUNT(*) FROM chat_rooms
UNION ALL
SELECT 'Chat rooms with messages', COUNT(DISTINCT m.chat_id) FROM messages m;

-- 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫–∏–µ bookings –µ—â–µ –±–µ–∑ —á–∞—Ç–æ–≤
SELECT b.id, b.student_id, l.teacher_id
FROM bookings b
INNER JOIN lessons l ON l.id = b.lesson_id
WHERE b.status = 'active'
  AND NOT EXISTS (
    SELECT 1 FROM chat_rooms cr
    WHERE cr.teacher_id = l.teacher_id
      AND cr.student_id = b.student_id
  );
```

---

## üìã –ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫–æ–π –º–µ—Ç–æ–¥?

| –°–∏—Ç—É–∞—Ü–∏—è | –ú–µ—Ç–æ–¥ 1 | –ú–µ—Ç–æ–¥ 2 |
|----------|---------|---------|
| –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç | ‚ùå | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ |
| –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç | ‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å | ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π |
| –°—Ç–∞—Ä—ã–µ —É—Ä–æ–∫–∏ | ‚úÖ –ü–æ–ª–µ–∑–µ–Ω | ‚úÖ –¢–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| –ù–æ–≤—ã–µ —É—Ä–æ–∫–∏ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ‚úÖ –õ—É—á—à–µ |

**–í—ã–≤–æ–¥:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –ú–µ—Ç–æ–¥ 2 –¥–ª—è –Ω–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º. –ú–µ—Ç–æ–¥ 1 –æ—Å—Ç–∞–≤–ª—è–π –∫–∞–∫ fallback –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö.
